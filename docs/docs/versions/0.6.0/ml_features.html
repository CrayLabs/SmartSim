

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>ML Features &#8212; SmartSim 0.6.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/tabs.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ml_features';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="SmartSim API" href="api/smartsim_api.html" />
    <link rel="prev" title="Launchers" href="launchers.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">SmartSim 0.6.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="versions.html">Versions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation_instructions/basic.html">Basic Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation_instructions/platform.html">Installation on specific platforms</a></li>







<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="smartsim_zoo.html">Contributing Examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorials/getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/online_analysis/lattice/online_analysis.html">Online Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/ml_inference/Inference-in-SmartSim.html">Online Inference</a></li>

<li class="toctree-l1"><a class="reference internal" href="tutorials/ml_training/surrogate/train_surrogate.html">Online Training</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartSim</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="experiment.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="orchestrator.html">Orchestrator</a></li>
<li class="toctree-l1"><a class="reference internal" href="launchers.html">Launchers</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">ML Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/smartsim_api.html">SmartSim API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartRedis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="smartredis.html">SmartRedis</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_integration.html">Integrating into a Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_python_walkthrough.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_cpp_walkthrough.html">C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_fortran_walkthrough.html">Fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_data_structures.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_dataset_conversions.html">DataSet Conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_runtime.html">Runtime Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_advanced_topics.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/smartredis_api.html">SmartRedis API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartDashboard</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="smartdashboard.html">SmartDashboard</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/CrayLabs/SmartSim" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/CrayLabs/SmartSim/issues/new?title=Issue%20on%20page%20%2Fml_features.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/ml_features.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ML Features</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ml-model-deployment-and-execution-in-the-database">ML Model Deployment and Execution in the Database</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensorflow-and-pytorch">TensorFlow and PyTorch</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#serializing-the-model-and-uploading-it-to-the-db-from-memory">Serializing the model and uploading it to the DB from memory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-the-model-to-a-file-and-uploading-it-to-the-db">Saving the model to a file and uploading it to the DB</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-the-model-on-tensors-stored-in-the-db">Executing the model on tensors stored in the DB</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#torchscript-functions">TorchScript Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#uploading-a-script-containing-a-collection-of-functions-to-the-db">Uploading a script containing a collection of functions to the DB</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#uploading-a-function-to-the-db-on-the-fly">Uploading a function to the DB on-the-fly</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#onnx-runtime">ONNX Runtime</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="ml-features">
<h1>ML Features<a class="headerlink" href="#ml-features" title="Permalink to this heading">#</a></h1>
<p>In this section, we illustrate features which
users are expected to use in HPC workloads, especially when
simulation and AI are required to interact. The topics are
explained through code snippets,
with code that goes beyond SmartSim and SmartRedis API
(e.g. code showing how to jit-script a PyTorch model): the
intention is that of showing <em>one</em> simple way of leveraging
a feature, but more optimized ways of using third-party
libraries may exist.</p>
<p>Examples are written in Python, but the same
result can be achieved with any SmartRedis client (C, C++,
Fortran and Python). Please refer to SmartRedis API
for language-specific details.</p>
<section id="ml-model-deployment-and-execution-in-the-database">
<h2>ML Model Deployment and Execution in the Database<a class="headerlink" href="#ml-model-deployment-and-execution-in-the-database" title="Permalink to this heading">#</a></h2>
<p>The combination of SmartSim and SmartRedis enables users
to store more than simple tensors on the database (DB).
In the upcoming subsections, we demonstrate how to use a
SmartRedis client to upload executable code, in the
form of ML model, scripts, and functions, to the DB.
Once store, the code can be executed using the SmartRedis client
methods and used to process tensors directly in the DB.
The tensors generated from running the stored code will also be stored
in the database and can be retrieved with standard SmartRedis <code class="docutils literal notranslate"><span class="pre">Client.get_tensor()</span></code> calls.</p>
<p>SmartRedis offers two ways to upload serialized code
to the DB: from memory and from file. We will go through examples
demonstrating how to upload from each. We provide the following examples:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ml-features-tf-pt"><span class="std std-ref">TensorFlow and PyTorch</span></a>: Serialize a TensorFlow/Keras or PyTorch model, optionally
save it to file, upload it to the DB, then execute it on tensors stored on the DB.</p></li>
<li><p><a class="reference internal" href="#ml-features-torchscript"><span class="std std-ref">TorchScript Functions</span></a>: Serialize TorchScript functions, optionally
save them to file, upload them to the DB, then execute them on tensors stored on the DB.</p></li>
<li><p><a class="reference internal" href="#ml-features-onnx"><span class="std std-ref">ONNX Runtime</span></a>: Convert a Scikit-Learn model to ONNX
format, upload it to the DB, then execute it on tensors stored on the DB.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In all examples, we will assume that a SmartSim <code class="docutils literal notranslate"><span class="pre">Orchestator</span></code>
is up and running, and that the code we will show is run as part
of a SmartSim-launched application <code class="docutils literal notranslate"><span class="pre">Model</span></code>.</p>
</div>
<section id="tensorflow-and-pytorch">
<span id="ml-features-tf-pt"></span><h3>TensorFlow and PyTorch<a class="headerlink" href="#tensorflow-and-pytorch" title="Permalink to this heading">#</a></h3>
<p>In this section, we will see how a TensorFlow/Keras or a PyTorch model
can be serialized using SmartSimâ€™s helper functions.
Once the model is serialized, we will use the SmartRedis client to upload it to the DB,
and execute it on data stored on the DB.
We will also see how the model can be optionally saved to file. The
workflow for TensorFlow and PyTorch is almost identical, but we provide
the code for each toolkit in a dedicated tab, for completeness.</p>
<p>We begin by defining the ML model that we will use in both examples of
this section.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-VGVuc29yRmxvdw==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tab" tabindex="0">TensorFlow</button><button aria-controls="panel-0-UHlUb3JjaA==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tab" tabindex="-1">PyTorch</button></div><div aria-labelledby="tab-0-VGVuc29yRmxvdw==" class="sphinx-tabs-panel group-tab" id="panel-0-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">smartsim.ml.tf</span> <span class="kn">import</span> <span class="n">freeze_model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">layers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;flatten&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FCN&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Compile model with optimizer</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;sparse_categorical_crossentropy&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-UHlUb3JjaA==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="c1"># simple MNIST in PyTorch</span>
<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">9216</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="c1"># Instantiate the model</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<section id="serializing-the-model-and-uploading-it-to-the-db-from-memory">
<h4>Serializing the model and uploading it to the DB from memory<a class="headerlink" href="#serializing-the-model-and-uploading-it-to-the-db-from-memory" title="Permalink to this heading">#</a></h4>
<p>Once the model is instantiated, it needs to be serialized to be uploaded
to the DB using the SmartRedis client.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-VGVuc29yRmxvdw==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tab" tabindex="0">TensorFlow</button><button aria-controls="panel-1-UHlUb3JjaA==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tab" tabindex="-1">PyTorch</button></div><div aria-labelledby="tab-1-VGVuc29yRmxvdw==" class="sphinx-tabs-panel group-tab" id="panel-1-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tabpanel" tabindex="0"><p>As part of its <a class="reference internal" href="api/smartsim_api.html#smartsim-tf-api"><span class="std std-ref">TensorFlow helper functions</span></a>,
SmartSim provides <code class="docutils literal notranslate"><span class="pre">serialize_model()</span></code> to serialize a TensorFlow or Keras
model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">serialized_model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">serialize_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">serialize_model()</span></code> conveniently returns the model as bytestring
and the names of the input and output layers, which are now needed to upload the TensorFlow
model to the DB using <code class="docutils literal notranslate"><span class="pre">Client.set_model()</span></code>.
We also use <code class="docutils literal notranslate"><span class="pre">Client.put_tensor()</span></code> to upload a batch of 20 synthetic MNIST samples to the DB.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate and connect SmartRedis client to communicate with DB</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model_key</span> <span class="o">=</span> <span class="s2">&quot;mnist_cnn&quot;</span>
<span class="c1"># Set device to CPU if GPU not available to DB</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">,</span> <span class="n">serialized_model</span><span class="p">,</span> <span class="s2">&quot;TF&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span>
<span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-UHlUb3JjaA==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tabpanel" tabindex="0"><p>PyTorch requires models to be <a class="reference external" href="https://pytorch.org/docs/1.11/generated/torch.jit.save.html">jit-traced</a>.
The method <code class="docutils literal notranslate"><span class="pre">torch.jit.save()</span></code> can either store the model in memory or on file. Here,
we will keep it in memory as a bytestring.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example input needed for jit tracing</span>
<span class="n">example_forward_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mnist_images</span><span class="p">)</span>
<span class="n">model_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_buffer</span><span class="p">)</span>
<span class="n">serialized_model</span> <span class="o">=</span> <span class="n">model_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>Now that we have the serialized model, we can upload it to the DB using the <code class="docutils literal notranslate"><span class="pre">Client.set_model()</span></code>.</p>
<p>We also use <code class="docutils literal notranslate"><span class="pre">Client.put_tensor()</span></code> to upload a batch of 20 synthetic MNIST samples to the DB.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate and connect SmartRedis client to communicate with DB</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model_key</span> <span class="o">=</span> <span class="s2">&quot;mnist_cnn&quot;</span>
<span class="c1"># Set device to CPU if GPU not available to DB</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">serialized_model</span><span class="p">,</span> <span class="s2">&quot;TORCH&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>For details about <code class="docutils literal notranslate"><span class="pre">Client.set_model()</span></code>, please
refer to <a class="reference internal" href="api/smartredis_api.html#smartredis-api"><span class="std std-ref">SmartRedis API</span></a>.</p>
</section>
<section id="saving-the-model-to-a-file-and-uploading-it-to-the-db">
<h4>Saving the model to a file and uploading it to the DB<a class="headerlink" href="#saving-the-model-to-a-file-and-uploading-it-to-the-db" title="Permalink to this heading">#</a></h4>
<p>Once the model is compiled, it can be serialized and stored on the filesystem. This is
useful if the model has to be used at a later time. Once the model is saved to file,
it can be uploaded to the DB using the SmartRedis client.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-VGVuc29yRmxvdw==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tab" tabindex="0">TensorFlow</button><button aria-controls="panel-2-UHlUb3JjaA==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tab" tabindex="-1">PyTorch</button></div><div aria-labelledby="tab-2-VGVuc29yRmxvdw==" class="sphinx-tabs-panel group-tab" id="panel-2-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tabpanel" tabindex="0"><p>As part of its <a class="reference internal" href="api/smartsim_api.html#smartsim-tf-api"><span class="std std-ref">TensorFlow helper functions</span></a>,
SmartSim provides <code class="docutils literal notranslate"><span class="pre">freeze_model()</span></code> to serialize a TensorFlow or Keras
model and save it to file. In this example, the file will be named <code class="docutils literal notranslate"><span class="pre">mnist.pb</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;mnist.pb&quot;</span>
<span class="n">model_path</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">freeze_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">freeze_model()</span></code> conveniently returns the path to the serialized model file,
and the names of the input and output layers, which are noew needed to upload the TensorFlow
model to the DB using <code class="docutils literal notranslate"><span class="pre">Client.set_model_from_file()</span></code>. We also use
<code class="docutils literal notranslate"><span class="pre">Client.put_tensor()</span></code> to upload a synthetic MNIST sample to the DB.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model_key</span> <span class="o">=</span> <span class="s2">&quot;mnist_cnn&quot;</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_model_from_file</span><span class="p">(</span>
    <span class="n">model_key</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="s2">&quot;TF&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span>
<span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-UHlUb3JjaA==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tabpanel" tabindex="0"><p>PyTorch requires models to be <a class="reference external" href="https://pytorch.org/docs/1.11/generated/torch.jit.save.html">jit-traced</a>.
The method <code class="docutils literal notranslate"><span class="pre">torch.jit.save()</span></code> can either store the model in memory or on file. Here,
we will save it to a file located at <code class="docutils literal notranslate"><span class="pre">./traced_model.pt</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example input needed for jit tracing</span>
<span class="n">example_forward_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">example_forward_input</span><span class="p">)</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;./traced_model.pt&quot;</span>
<span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">modelpath</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that we have the serialized model, we can upload it to the DB using
<code class="docutils literal notranslate"><span class="pre">Client.set_model_from_file()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model_key</span> <span class="o">=</span> <span class="s2">&quot;mnist_cnn&quot;</span>

<span class="n">client</span><span class="o">.</span><span class="n">set_model_from_file</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="s2">&quot;TORCH&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>For details about <code class="docutils literal notranslate"><span class="pre">Client.set_model_from_file()</span></code>, please
refer to <a class="reference internal" href="api/smartredis_api.html#smartredis-api"><span class="std std-ref">SmartRedis API</span></a>.</p>
</section>
<section id="executing-the-model-on-tensors-stored-in-the-db">
<h4>Executing the model on tensors stored in the DB<a class="headerlink" href="#executing-the-model-on-tensors-stored-in-the-db" title="Permalink to this heading">#</a></h4>
<p>Now that the model is available for execution on the DB, we use the SmartRedis client
to upload a tensor representing a batch of 20 synthetic MNIST images.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-VGVuc29yRmxvdw==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tab" tabindex="0">TensorFlow</button><button aria-controls="panel-3-UHlUb3JjaA==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tab" tabindex="-1">PyTorch</button></div><div aria-labelledby="tab-3-VGVuc29yRmxvdw==" class="sphinx-tabs-panel group-tab" id="panel-3-VGVuc29yRmxvdw==" name="VGVuc29yRmxvdw==" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 20 samples of &quot;image&quot; data</span>
<span class="n">mnist_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="c1"># client was instantiated previously</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;mnist_images&quot;</span><span class="p">,</span> <span class="n">mnist_image</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-UHlUb3JjaA==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-UHlUb3JjaA==" name="UHlUb3JjaA==" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 20 samples of &quot;image&quot; data</span>
<span class="n">mnist_images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="c1"># client was instantiated previously</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;mnist_images&quot;</span><span class="p">,</span> <span class="n">mnist_images</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div></div>
<p>Now we can use <code class="docutils literal notranslate"><span class="pre">Client.run_model()</span></code> to execute the model on the data we have
just stored and <code class="docutils literal notranslate"><span class="pre">Client.get_tensor()</span></code> to download the output of the model execution.
Notice that, for this part, the code is identical for models uploaded from file and from memory, and
with TensorFlow or PyTorch backends.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mnist_imagse&quot;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mnist_output&quot;</span><span class="p">])</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;mnist_output&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For details about <code class="docutils literal notranslate"><span class="pre">Client.run_model()</span></code>, please
refer to <a class="reference internal" href="api/smartredis_api.html#smartredis-api"><span class="std std-ref">SmartRedis API</span></a>.</p>
</section>
</section>
<section id="torchscript-functions">
<span id="ml-features-torchscript"></span><h3>TorchScript Functions<a class="headerlink" href="#torchscript-functions" title="Permalink to this heading">#</a></h3>
<p>Instead of Neural Networks, or, in general, Machine Learning models, it is
possible to upload to the DB (collections of) functions which can be used e.g.
to perform pre- or post-processing operations on tensors stored on the DB.</p>
<p>Since the functions are going to be stored as TorchScript modules, they</p>
<ul class="simple">
<li><p>need to be jit-traceable</p></li>
<li><p>can use <code class="docutils literal notranslate"><span class="pre">torch</span></code> as a built-in module</p></li>
<li><p>can <strong>not</strong> import modules</p></li>
</ul>
<p>In this section we will see how to</p>
<ul class="simple">
<li><p>save a collection of functions to a script file, upload them to the DB,
and execute them on tensors stored on the DB.</p></li>
<li><p>define and upload a function on-the-fly from a Python script and
execute it on tensors stored on the DB.</p></li>
</ul>
<section id="uploading-a-script-containing-a-collection-of-functions-to-the-db">
<h4>Uploading a script containing a collection of functions to the DB<a class="headerlink" href="#uploading-a-script-containing-a-collection-of-functions-to-the-db" title="Permalink to this heading">#</a></h4>
<p>The easiest way of defining and storing functions on the DB is to create a
dedicated file. In that file, we can define functions which will be callable
through the SmartRedis client, but also from other functions in the
same file. A typical script file would look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="n">normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">tensor</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">std</span>
    <span class="k">return</span> <span class="n">tensor</span><span class="o">*</span><span class="n">sigma</span> <span class="o">+</span> <span class="n">mu</span>

<span class="k">def</span> <span class="nf">shift_y_to_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">mu_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">y_rescaled</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_rescaled</span>
</pre></div>
</div>
<p>In the script, we defined <code class="docutils literal notranslate"><span class="pre">shift_y_to_x</span></code>,
a function which returns a modified copy of a tensor <code class="docutils literal notranslate"><span class="pre">y</span></code>,
which matches the statistical distribution of the tensor <code class="docutils literal notranslate"><span class="pre">x</span></code>.
Notice that we are not importing <code class="docutils literal notranslate"><span class="pre">torch</span></code> in the script, as it will
be recognized as a built-in by the TorchScript compiler. Because
of the discrepancy between TorchScriptâ€™s and Pythonâ€™s syntaxes, TorchScript
scripts cannot be run as standalone Python scripts.</p>
<p>Here is the code which allows us to run the function <code class="docutils literal notranslate"><span class="pre">shift_y_to_x</span></code> on
tensors stored in the DB. We will assume that the above script is stored
as <code class="docutils literal notranslate"><span class="pre">&quot;./shift.script&quot;</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="c1"># Generate tensors according to two different random distributions</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span>

<span class="c1"># Instantiate and connect SmartRedis client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Upload tensors to DB</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;X_rand&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;Y_rand&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Upload script containing functions to DB</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_script_from_file</span><span class="p">(</span><span class="s2">&quot;shifter&quot;</span><span class="p">,</span> <span class="s2">&quot;./shift.script&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="c1"># Run the function ``shift_y_to_x`` on ``X_rand`` and ``Y_rand``</span>
<span class="n">client</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="s2">&quot;shifter&quot;</span><span class="p">,</span> <span class="s2">&quot;shift_y_to_x&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X_rand&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_rand&quot;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Y_scaled&quot;</span><span class="p">])</span>
<span class="c1"># Download output</span>
<span class="n">y_scaled</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;Y_scaled&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above code, we used <code class="docutils literal notranslate"><span class="pre">Client.put_tensor()</span></code> to upload tensors to the DB, and
<code class="docutils literal notranslate"><span class="pre">Client.set_script_from_file()</span></code> to upload the script containing the collection of functions.
We then used <code class="docutils literal notranslate"><span class="pre">Client.run_script()</span></code> to run the function <code class="docutils literal notranslate"><span class="pre">shift_y_to_x</span></code> on the stored
tensors, and downloaded the result with <code class="docutils literal notranslate"><span class="pre">Client.get_tensor()</span></code>.</p>
<p>For details about <code class="docutils literal notranslate"><span class="pre">Client.set_script_from_file()</span></code> and <code class="docutils literal notranslate"><span class="pre">Client.run_script()</span></code>, please
refer to <a class="reference internal" href="api/smartredis_api.html#smartredis-api"><span class="std std-ref">SmartRedis API</span></a>.</p>
</section>
<section id="uploading-a-function-to-the-db-on-the-fly">
<h4>Uploading a function to the DB on-the-fly<a class="headerlink" href="#uploading-a-function-to-the-db-on-the-fly" title="Permalink to this heading">#</a></h4>
<p>Simpler functions (or functions that do not require calling other user-defined
or imported functions), can be defined inline and uploaded to the DB using the SmartRedis client.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple function to normalize a tensor&quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">std</span>

<span class="c1"># Generate random tensor</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span>

<span class="c1"># Instantiate and connect SmartRedis client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Upload tensor to DB</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;X_rand&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Upload function to DB, ``normalizer`` is the name of the collection</span>
<span class="c1"># of functions containing the function ``normalize`` only. It mimics</span>
<span class="c1"># the way `set_script` works.</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_function</span><span class="p">(</span><span class="s2">&quot;normalizer&quot;</span><span class="p">,</span> <span class="n">normalize</span><span class="p">)</span>
<span class="c1"># Run the function ``normalize`` on ``X_rand``</span>
<span class="n">client</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="s2">&quot;normalizer&quot;</span><span class="p">,</span> <span class="s2">&quot;normalize&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X_rand&quot;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X_norm&quot;</span><span class="p">])</span>
<span class="c1"># Download output</span>
<span class="n">x_norm</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;X_norm&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that the key <code class="docutils literal notranslate"><span class="pre">&quot;normalizer&quot;</span></code> represents the script containing the function (similar to
<code class="docutils literal notranslate"><span class="pre">&quot;shifter&quot;</span></code> in the previous example), while the function name is <code class="docutils literal notranslate"><span class="pre">&quot;normalize&quot;</span></code>.</p>
<p>For details about <code class="docutils literal notranslate"><span class="pre">Client.set_function()</span></code> and  <code class="docutils literal notranslate"><span class="pre">Client.run_script()</span></code>, please
refer to <a class="reference internal" href="api/smartredis_api.html#smartredis-api"><span class="std std-ref">SmartRedis API</span></a>.</p>
</section>
</section>
<section id="onnx-runtime">
<span id="ml-features-onnx"></span><h3>ONNX Runtime<a class="headerlink" href="#onnx-runtime" title="Permalink to this heading">#</a></h3>
<p>In the following example, we will see how, thanks to the ONNX runtime,
Machine Learning and Data Analysis functions defined in
Scikit-Learn can be serialized and then put on the DB using the SmartRedis client.</p>
<p>We start by defining a Scikit-Learn <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> model and serialize it,
keeping it into memory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="k">def</span> <span class="nf">build_lin_reg</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates sklearn linear regression model and serialize it&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">linreg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
    <span class="n">linreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">linreg</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">linreg</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">linreg</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

<span class="n">linreg</span> <span class="o">=</span> <span class="n">build_lin_reg</span><span class="p">()</span>
</pre></div>
</div>
<p>Once the model is serialized, we can use <code class="docutils literal notranslate"><span class="pre">Client.set_model()</span></code> to upload it
to the DB.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># connect a client to the database</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="s2">&quot;linreg&quot;</span><span class="p">,</span> <span class="n">linreg</span><span class="p">,</span> <span class="s2">&quot;ONNX&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we can upload a tensor to the DB using <code class="docutils literal notranslate"><span class="pre">Client.put_tensor()</span></code>, run the
stored model on it using <code class="docutils literal notranslate"><span class="pre">Client.run_model()</span></code>, and download the output calling
<code class="docutils literal notranslate"><span class="pre">Client.get_tensor()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># linreg test</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="s2">&quot;linreg&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For details about <code class="docutils literal notranslate"><span class="pre">Client.run_model()</span></code>, please
refer to <a class="reference internal" href="api/smartredis_api.html#smartredis-api"><span class="std std-ref">SmartRedis API</span></a>.</p>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="launchers.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Launchers</p>
      </div>
    </a>
    <a class="right-next"
       href="api/smartsim_api.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">SmartSim API</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ml-model-deployment-and-execution-in-the-database">ML Model Deployment and Execution in the Database</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensorflow-and-pytorch">TensorFlow and PyTorch</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#serializing-the-model-and-uploading-it-to-the-db-from-memory">Serializing the model and uploading it to the DB from memory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-the-model-to-a-file-and-uploading-it-to-the-db">Saving the model to a file and uploading it to the DB</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-the-model-on-tensors-stored-in-the-db">Executing the model on tensors stored in the DB</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#torchscript-functions">TorchScript Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#uploading-a-script-containing-a-collection-of-functions-to-the-db">Uploading a script containing a collection of functions to the DB</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#uploading-a-function-to-the-db-on-the-fly">Uploading a function to the DB on-the-fly</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#onnx-runtime">ONNX Runtime</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cray Labs
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2021-2023, Hewlett Packard Enterprise.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  Questions? You can contact <a href="mailto:craylabs@hpe.com">contact us</a> or <a href="https://join.slack.com/t/craylabs/shared_invite/zt-nw3ag5z5-5PS4tIXBfufu1bIvvr71UA">join us on Slack!</a>
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>