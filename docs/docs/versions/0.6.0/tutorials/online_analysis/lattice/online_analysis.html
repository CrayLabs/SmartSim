

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Online Analysis &#8212; SmartSim 0.6.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nbsphinx-code-cells.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/online_analysis/lattice/online_analysis';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Online Inference" href="../../ml_inference/Inference-in-SmartSim.html" />
    <link rel="prev" title="Getting Started" href="../../getting_started/getting_started.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">SmartSim 0.6.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../versions.html">Versions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation_instructions/basic.html">Basic Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation_instructions/platform.html">Installation on specific platforms</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../smartsim_zoo.html">Contributing Examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Online Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ml_inference/Inference-in-SmartSim.html">Online Inference</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../ml_training/surrogate/train_surrogate.html">Online Training</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartSim</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../experiment.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../orchestrator.html">Orchestrator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../launchers.html">Launchers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ml_features.html">ML Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/smartsim_api.html">SmartSim API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartRedis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../smartredis.html">SmartRedis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_integration.html">Integrating into a Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_python_walkthrough.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_cpp_walkthrough.html">C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_fortran_walkthrough.html">Fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_data_structures.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_dataset_conversions.html">DataSet Conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_runtime.html">Runtime Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sr_advanced_topics.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/smartredis_api.html">SmartRedis API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartDashboard</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../smartdashboard.html">SmartDashboard</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer.html">Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">Testing</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/CrayLabs/SmartSim" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/CrayLabs/SmartSim/issues/new?title=Issue%20on%20page%20%2Ftutorials/online_analysis/lattice/online_analysis.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/tutorials/online_analysis/lattice/online_analysis.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Online Analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Lattice-Boltzmann-Simulation">Lattice Boltzmann Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Integrating-SmartRedis">Integrating SmartRedis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Starting-the-Experiment">Starting the Experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Running-the-Simulation">Running the Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Online-Visualization">Online Visualization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Post-processing-with-TorchScript">Post-processing with TorchScript</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Uploading-a-script">Uploading a script</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Uploading-a-function-inline">Uploading a function inline</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="Online-Analysis">
<h1>Online Analysis<a class="headerlink" href="#Online-Analysis" title="Permalink to this heading">#</a></h1>
<p>Being able to visualize and interpret simulation data in real time is invaluable for understanding the behavior of a physical system.</p>
<p>SmartSim can be used to stream data from Fortran, C, and C++ simulations to Python where visualization is significantly easier and more interactive.</p>
<p>This example shows how to use SmartSim analyze the vorticity field during a simple, Python based Lattice Boltzmann fluid flow simulation.</p>
<section id="Lattice-Boltzmann-Simulation">
<h2>Lattice Boltzmann Simulation<a class="headerlink" href="#Lattice-Boltzmann-Simulation" title="Permalink to this heading">#</a></h2>
<p>This example was adapted from Philip Mocz’s <a class="reference external" href="https://github.com/pmocz/latticeboltzmann-python">implementation</a> of the lattice Boltzmann method in Python. Since that example is licensed under GPL, so is this example.</p>
<p>Philip also wrote a great medium <a class="reference external" href="https://medium.com/swlh/create-your-own-lattice-boltzmann-simulation-with-python-8759e8b53b1c">article</a> explaining the simulation in detail.</p>
<p><img alt="lattice" class="no-scaled-link" src="https://github.com/CrayLabs/SmartSim/blob/develop/doc/images/latticeboltzmann.png?raw=true" style="width: 600px;" /></p>
</section>
<section id="Integrating-SmartRedis">
<h2>Integrating SmartRedis<a class="headerlink" href="#Integrating-SmartRedis" title="Permalink to this heading">#</a></h2>
<p>Typically HPC simulations are written in C, C++, Fortran or other high performance languages. Embedding the SmartRedis client usually involves compiling in the SmartRedis library into the simulation.</p>
<p>Because this simulation is written in Python, we can use the SmartRedis Python client to stream data to the database. To make the visualization easier, we use the SmartRedis <a class="reference external" href="https://www.craylabs.org/docs/sr_data_structures.html#dataset">Dataset</a> object to hold two 2D NumPy arrays. A convenience function is provided to convert the fields into a dataset object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select lines from updated simulation code highlighting</span>
<span class="c1"># the use of SmartRedis to stream data to another processes</span>

<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span> <span class="c1"># Addresses passed to job through SmartSim launch</span>

<span class="c1"># send cylinder location only once</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;cylinder&quot;</span><span class="p">,</span> <span class="n">cylinder</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span>
    <span class="c1"># send every 5 time_step to reduce memory consumption</span>
    <span class="k">if</span> <span class="n">time_step</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">put_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create SmartRedis Dataset containing multiple NumPy arrays</span>
<span class="sd">    to be stored at a single key within the database&quot;&quot;&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">time_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">add_tensor</span><span class="p">(</span><span class="s2">&quot;ux&quot;</span><span class="p">,</span> <span class="n">ux</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">add_tensor</span><span class="p">(</span><span class="s2">&quot;uy&quot;</span><span class="p">,</span> <span class="n">uy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</div>
<p>This is all the SmartRedis code needed to stream the simulation data. Note that the client does not need to have an address explicitly stated because we are going to be launching the simulation through SmartSim as shown in the cell below</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">smartsim</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">vishelpers</span> <span class="kn">import</span> <span class="n">plot_lattice_vorticity</span><span class="p">,</span> <span class="n">plot_lattice_norm</span><span class="p">,</span> <span class="n">plot_lattice_probes</span>
</pre></div>
</div>
</div>
</section>
<section id="Starting-the-Experiment">
<h2>Starting the Experiment<a class="headerlink" href="#Starting-the-Experiment" title="Permalink to this heading">#</a></h2>
<p>SmartSim, the infrastructure library, is used here to launch both the database and the simulation locally, but in separate processes. The example is designed to run on laptops, so the local launcher is used.</p>
<p>First the necessary libraries are imported and an <code class="docutils literal notranslate"><span class="pre">Experiment</span></code> instance is created. An <code class="docutils literal notranslate"><span class="pre">Orchestrator</span></code> database reference is intialized and launched to stage data between the simulation and this notebook where we will be performing the analysis.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize an Experiment with the local launcher</span>
<span class="c1"># This will be the name of the output directory that holds</span>
<span class="c1"># the output from our simulation and SmartSim</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="s2">&quot;finite_volume_simulation&quot;</span><span class="p">,</span> <span class="n">launcher</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create an Orchestrator database reference,</span>
<span class="c1"># generate it&#39;s output directory, and launch it locally</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">6780</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;lo&quot;</span><span class="p">)</span>
<span class="n">exp</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">exp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database started at address: </span><span class="si">{</span><span class="n">db</span><span class="o">.</span><span class="n">get_address</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Database started at address: [&#39;127.0.0.1:6780&#39;]
</pre></div></div>
</div>
</section>
<section id="Running-the-Simulation">
<h2>Running the Simulation<a class="headerlink" href="#Running-the-Simulation" title="Permalink to this heading">#</a></h2>
<p>To run the simulation, <code class="docutils literal notranslate"><span class="pre">Experiment.create_run_settings</span></code> is used to define how the simulation should be executed. These settings are then passed to create a reference to the simulation through a call to <code class="docutils literal notranslate"><span class="pre">Experiment.create_model()</span></code> which can be used to start, monitor, and stop the simulation from this notebook.</p>
<p>Once the model is defined it is started by passing the reference to <code class="docutils literal notranslate"><span class="pre">Experiment.start()</span></code> The simulation is started with the <code class="docutils literal notranslate"><span class="pre">block=False</span></code> argument. This runs the simulation in a nonblocking manner so that the data being streamed from the simulation can be analyzed in real time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set simulation parameters we can pass as executable arguments</span>
<span class="n">time_steps</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">42</span>

<span class="c1"># create &quot;run settings&quot; for the simulation which define how</span>
<span class="c1"># the simulation will be executed when passed to Experiment.start()</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">create_run_settings</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                                   <span class="n">exe_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fv_sim.py&quot;</span><span class="p">,</span>
                                             <span class="sa">f</span><span class="s2">&quot;--seed=</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                             <span class="sa">f</span><span class="s2">&quot;--steps=</span><span class="si">{</span><span class="n">time_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>

<span class="c1"># Create the Model reference to our simulation and</span>
<span class="c1"># attach needed files to be copied, configured, or symlinked into</span>
<span class="c1"># the Model directory at runtime.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="s2">&quot;fv_simulation&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">attach_generator_files</span><span class="p">(</span><span class="n">to_copy</span><span class="o">=</span><span class="s2">&quot;fv_sim.py&quot;</span><span class="p">)</span>
<span class="n">exp</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start simulation without blocking so data can be analyzed in real time</span>
<span class="n">exp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
19:49:59 C02YR4ANLVCJ SmartSim[54122] INFO

=== Launch Summary ===
Experiment: finite_volume_simulation
Experiment Path: /Users/arigazzi/Documents/DeepLearning/smartsim-dev/SmartSim/tutorials/online_analysis/lattice/finite_volume_simulation
Launcher: local
Models: 1
Database Status: active

=== Models ===
fv_simulation
Executable: /usr/local/anaconda3/envs/ss-py3.10/bin/python
Executable Arguments: fv_sim.py --seed=42 --steps=3000



</pre></div></div>
</div>
</section>
<section id="Online-Visualization">
<h2>Online Visualization<a class="headerlink" href="#Online-Visualization" title="Permalink to this heading">#</a></h2>
<p>SmartRedis is used to pull the Datasets stored in the Orchestrator database by the simulation and use matplotlib to plot the results.</p>
<p>In this example, we are running the visualization in an interactive manner. If instead we wanted to encapsulate this workflow to deploy on an HPC platform we could have created another <code class="docutils literal notranslate"><span class="pre">Model</span></code> to plot the results and launched in a similar manner to the simulation. Doing so would enable the analysis application to be executed on different resources such as GPU enabled nodes, or distributed across many nodes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># connect a SmartRedis client to retrieve data while the</span>
<span class="c1"># simulation is producing it and storing it within the</span>
<span class="c1"># orchestrator database</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">get_address</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Get the cylinder location in the mesh</span>
<span class="n">client</span><span class="o">.</span><span class="n">poll_key</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cylinder&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">cylinder</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;cylinder&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

<span class="c1"># plot every 700th timestep</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="mi">700</span><span class="p">):</span>
    <span class="n">client</span><span class="o">.</span><span class="n">poll_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;ux&quot;</span><span class="p">),</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;uy&quot;</span><span class="p">)</span>

    <span class="n">plot_lattice_vorticity</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">cylinder</span><span class="p">)</span>

<span class="c1"># Use the Experiment API to wait until the model is finished</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">exp</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SmartRedis Library@19-49-59:WARNING: Environment variable SR_LOG_FILE is not set. Defaulting to stdout
SmartRedis Library@19-49-59:WARNING: Environment variable SR_LOG_LEVEL is not set. Defaulting to INFO
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_1.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_2.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_3.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_4.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_5.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_10_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
19:50:37 C02YR4ANLVCJ SmartSim[54122] INFO fv_simulation(54161): Completed
</pre></div></div>
</div>
</section>
<section id="Post-processing-with-TorchScript">
<h2>Post-processing with TorchScript<a class="headerlink" href="#Post-processing-with-TorchScript" title="Permalink to this heading">#</a></h2>
<p>We can upload <a class="reference external" href="https://pytorch.org/docs/1.11/jit.html">TorchScript functions</a> to the DB. Tensors which are stored on the DB can be passed as arguments to uploaded functions and the results will be stored on the DB. This makes it possible to perform pre- and post-processing operations on tensors localli, <em>in the DB</em>, reducing the number of data transfers.</p>
<section id="Uploading-a-script">
<h3>Uploading a script<a class="headerlink" href="#Uploading-a-script" title="Permalink to this heading">#</a></h3>
<p>We can load a file containing TorchScript-compatible functionsto the DB. For example, the file <code class="docutils literal notranslate"><span class="pre">./probe.script</span></code> contains the function <code class="docutils literal notranslate"><span class="pre">probe_points</span></code> which interpolates the values of <code class="docutils literal notranslate"><span class="pre">ux</span></code> and <code class="docutils literal notranslate"><span class="pre">uy</span></code> at some user-provided probe points. This is useful when we are interested in the value of a given fields only at specific locations.</p>
<p>The script looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">multi_unsqueeze</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tensor</span>

<span class="k">def</span> <span class="nf">probe_points</span><span class="p">(</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">probe_x</span><span class="p">,</span> <span class="n">probe_y</span><span class="p">,</span> <span class="n">cylinder</span><span class="p">):</span>
    <span class="n">ux</span><span class="p">[</span><span class="n">cylinder</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">uy</span><span class="p">[</span><span class="n">cylinder</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ux</span> <span class="o">=</span> <span class="n">multi_unsqueeze</span><span class="p">(</span><span class="n">ux</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">uy</span> <span class="o">=</span> <span class="n">multi_unsqueeze</span><span class="p">(</span><span class="n">uy</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">probe_xy</span> <span class="o">=</span> <span class="n">multi_unsqueeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">probe_x</span><span class="o">/</span><span class="mi">200</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">probe_y</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">u_probex</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">grid_sampler</span><span class="p">(</span><span class="n">ux</span><span class="o">.</span><span class="n">double</span><span class="p">(),</span> <span class="n">probe_xy</span><span class="o">.</span><span class="n">double</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">u_probey</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">grid_sampler</span><span class="p">(</span><span class="n">uy</span><span class="o">.</span><span class="n">double</span><span class="p">(),</span> <span class="n">probe_xy</span><span class="o">.</span><span class="n">double</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">u_probex</span><span class="p">,</span> <span class="n">u_probey</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we don’t have to import <code class="docutils literal notranslate"><span class="pre">torch</span></code>, as the TorchScript interpreter will recognize it as a builtin module.</p>
<p>We then proceed to upload the script to the DB under the key <code class="docutils literal notranslate"><span class="pre">probe</span></code> and add the probe points as tensors to the DB.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">set_script_from_file</span><span class="p">(</span><span class="s2">&quot;probe&quot;</span><span class="p">,</span> <span class="s2">&quot;./probe.script&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>

<span class="n">probe_x</span><span class="p">,</span> <span class="n">probe_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;probe_x&quot;</span><span class="p">,</span> <span class="n">probe_x</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">put_tensor</span><span class="p">(</span><span class="s2">&quot;probe_y&quot;</span><span class="p">,</span> <span class="n">probe_y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Default@19-50-39:ERROR: Redis IO error when executing command: Failed to get reply: Resource temporarily unavailable
Default@19-50-40:ERROR: Redis IO error when executing command: Failed to get reply: Resource temporarily unavailable
Default@19-50-41:ERROR: Redis IO error when executing command: Failed to get reply: Resource temporarily unavailable
Default@19-50-43:ERROR: Redis IO error when executing command: Failed to get reply: Resource temporarily unavailable
</pre></div></div>
</div>
<p>We then apply the function <code class="docutils literal notranslate"><span class="pre">probe_points</span></code> to the <code class="docutils literal notranslate"><span class="pre">ux</span></code> and <code class="docutils literal notranslate"><span class="pre">uy</span></code> tensors computed in the last time step of the previous simulation. Note that all tensors are already on the DB, thus we can reference them by name. Finally, we download and plot the output (a 2D velocity field), which is stored as <code class="docutils literal notranslate"><span class="pre">probe_u</span></code> on the DB.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ux_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">data_</span><span class="si">{</span><span class="n">time_steps</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">.ux&quot;</span>
<span class="n">uy_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">data_</span><span class="si">{</span><span class="n">time_steps</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="se">}}</span><span class="s2">.uy&quot;</span>

<span class="n">client</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="s2">&quot;probe&quot;</span><span class="p">,</span> <span class="s2">&quot;probe_points&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">ux_name</span><span class="p">,</span> <span class="n">uy_name</span> <span class="p">,</span> <span class="s2">&quot;probe_x&quot;</span><span class="p">,</span> <span class="s2">&quot;probe_y&quot;</span><span class="p">,</span> <span class="s2">&quot;cylinder&quot;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;probe_u&quot;</span><span class="p">])</span>

<span class="n">probe_u</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;probe_u&quot;</span><span class="p">)</span>
<span class="n">plot_lattice_probes</span><span class="p">(</span><span class="n">time_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">probe_x</span><span class="p">,</span> <span class="n">probe_y</span><span class="p">,</span> <span class="n">probe_u</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_14_0.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_14_0.png" />
</div>
</div>
</section>
<section id="Uploading-a-function-inline">
<h3>Uploading a function inline<a class="headerlink" href="#Uploading-a-function-inline" title="Permalink to this heading">#</a></h3>
<p>In some cases, it makes sense to define the TorchScript function directly in a Python script or in a Jupyter notebook, like in this case. Let us define a simple function which computes the norm of the velocity field.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">compute_norm</span><span class="p">(</span><span class="n">ux</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">uy</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ux</span><span class="o">*</span><span class="n">ux</span> <span class="o">+</span> <span class="n">uy</span><span class="o">*</span><span class="n">uy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We then store the function on the DB under the key <code class="docutils literal notranslate"><span class="pre">norm_function</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">set_function</span><span class="p">(</span><span class="s2">&quot;norm_function&quot;</span><span class="p">,</span> <span class="n">compute_norm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that the key we used identifies a functional unit containing the function itself: this is similar to the key used to store the <code class="docutils literal notranslate"><span class="pre">probe</span></code> script above. When we want to run the function, we just call it with <code class="docutils literal notranslate"><span class="pre">run_script</span></code>, by indicating the <code class="docutils literal notranslate"><span class="pre">script</span></code> key as <code class="docutils literal notranslate"><span class="pre">&quot;norm_function&quot;</span></code> and the name of the function itself as <code class="docutils literal notranslate"><span class="pre">&quot;compute_norm&quot;</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">time_steps</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="s2">&quot;norm_function&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_norm&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">}}</span><span class="s2">.uy&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">}}</span><span class="s2">.ux&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">)</span>

<span class="n">plot_lattice_norm</span><span class="p">(</span><span class="n">time_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">cylinder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_online_analysis_lattice_online_analysis_20_0.png" src="../../../_images/tutorials_online_analysis_lattice_online_analysis_20_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optionally clear the database</span>
<span class="n">client</span><span class="o">.</span><span class="n">flush_db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_address</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># terminate the database and</span>
<span class="c1"># release its resources</span>
<span class="n">exp</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<table>
<thead>
<tr><th>  </th><th>Name          </th><th>Entity-Type  </th><th>JobID  </th><th>RunID  </th><th>Time   </th><th>Status   </th><th>Returncode  </th></tr>
</thead>
<tbody>
<tr><td>0 </td><td>fv_simulation </td><td>Model        </td><td>54161  </td><td>0      </td><td>38.1561</td><td>Completed</td><td>0           </td></tr>
<tr><td>1 </td><td>orchestrator_0</td><td>DBNode       </td><td>54134  </td><td>0      </td><td>66.5750</td><td>Cancelled</td><td>0           </td></tr>
</tbody>
</table></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../../getting_started/getting_started.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Getting Started</p>
      </div>
    </a>
    <a class="right-next"
       href="../../ml_inference/Inference-in-SmartSim.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Online Inference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Lattice-Boltzmann-Simulation">Lattice Boltzmann Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Integrating-SmartRedis">Integrating SmartRedis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Starting-the-Experiment">Starting the Experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Running-the-Simulation">Running the Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Online-Visualization">Online Visualization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Post-processing-with-TorchScript">Post-processing with TorchScript</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Uploading-a-script">Uploading a script</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Uploading-a-function-inline">Uploading a function inline</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cray Labs
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2023, Hewlett Packard Enterprise.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  Questions? You can contact <a href="mailto:craylabs@hpe.com">contact us</a> or <a href="https://join.slack.com/t/craylabs/shared_invite/zt-nw3ag5z5-5PS4tIXBfufu1bIvvr71UA">join us on Slack!</a>
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>