

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Integrating into a Simulation &#8212; SmartSim 0.6.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'sr_integration';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Python" href="sr_python_walkthrough.html" />
    <link rel="prev" title="SmartRedis" href="smartredis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">SmartSim 0.6.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="versions.html">Versions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation_instructions/basic.html">Basic Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation_instructions/platform.html">Installation on specific platforms</a></li>







<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="smartsim_zoo.html">Contributing Examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorials/getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/online_analysis/lattice/online_analysis.html">Online Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/ml_inference/Inference-in-SmartSim.html">Online Inference</a></li>

<li class="toctree-l1"><a class="reference internal" href="tutorials/ml_training/surrogate/train_surrogate.html">Online Training</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartSim</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="experiment.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="orchestrator.html">Orchestrator</a></li>
<li class="toctree-l1"><a class="reference internal" href="launchers.html">Launchers</a></li>
<li class="toctree-l1"><a class="reference internal" href="ml_features.html">ML Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/smartsim_api.html">SmartSim API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartRedis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="smartredis.html">SmartRedis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Integrating into a Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_python_walkthrough.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_cpp_walkthrough.html">C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_fortran_walkthrough.html">Fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_data_structures.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_dataset_conversions.html">DataSet Conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_runtime.html">Runtime Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="sr_advanced_topics.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/smartredis_api.html">SmartRedis API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SmartDashboard</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="smartdashboard.html">SmartDashboard</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/CrayLabs/SmartSim" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/CrayLabs/SmartSim/issues/new?title=Issue%20on%20page%20%2Fsr_integration.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/sr_integration.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Integrating into a Simulation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization">Initialization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-client">Creating the client</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-programs-creating-unique-names">(Parallel Programs): Creating unique names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-scripts-and-models">Storing scripts and models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-loop">Main loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-example">Full example</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="integrating-into-a-simulation">
<h1>Integrating into a Simulation<a class="headerlink" href="#integrating-into-a-simulation" title="Permalink to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>This document provides some general guidelines to integrate the SmartRedis client
into existing simulation codebases. Developers of these simulation codebases will
need to identify the exact places to add the code; generally SmartRedis calls
will only need to be added in two places:</p>
<ol class="arabic simple">
<li><p>Initialization</p></li>
<li><p>Main loop</p></li>
</ol>
</section>
<section id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Permalink to this heading">#</a></h2>
<section id="creating-the-client">
<h3>Creating the client<a class="headerlink" href="#creating-the-client" title="Permalink to this heading">#</a></h3>
<p>The SmartRedis client must be initialized before it can be used to communicate
with the orchestrator. In the C++ and Python versions of the clients, this is done
when creating a new client. In the C and Fortran client an <cite>initialize</cite>
method must be called.</p>
<p>C++:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;client.h&quot;</span>
<span class="n">SmartRedis</span><span class="p">::</span><span class="n">Client</span> <span class="n">client</span><span class="p">(</span><span class="n">use_cluster</span><span class="p">);</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">smartredis</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">use_cluster</span><span class="p">)</span>
</pre></div>
</div>
<p>Fortran:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">smartredis_client</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">client_type</span>
<span class="n">include</span> <span class="s2">&quot;enum_fortran.inc&quot;</span>

<span class="nb">type</span><span class="p">(</span><span class="n">client_type</span><span class="p">)</span> <span class="p">::</span> <span class="n">client</span>
<span class="n">return_code</span> <span class="o">=</span> <span class="n">client</span><span class="o">%</span><span class="n">initialize</span><span class="p">(</span><span class="n">use_cluster</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">.</span><span class="n">ne</span><span class="o">.</span> <span class="n">SRNoError</span><span class="p">)</span> <span class="n">stop</span> <span class="s1">&#39;Error in initialization&#39;</span>
</pre></div>
</div>
<p>C:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;client.h&quot;</span>
<span class="c1">#include &quot;sr_enums.h&quot;</span>
<span class="n">void</span><span class="o">*</span> <span class="n">client</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
<span class="n">return_code</span> <span class="o">=</span> <span class="n">SmartRedisCClient</span><span class="p">(</span><span class="n">use_cluster</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">!=</span> <span class="n">SRNoError</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All these methods only have one configurable parameter – indicated in the
above cases by the variable <cite>use_cluster</cite>. If this parameter is true,
then the client expects to be able to communicate with an orchestrator with
three or more shards.</p>
</section>
<section id="parallel-programs-creating-unique-names">
<h3>(Parallel Programs): Creating unique names<a class="headerlink" href="#parallel-programs-creating-unique-names" title="Permalink to this heading">#</a></h3>
<p>For parallel applications, each rank or thread that is communicating with
the orchestrator will likely need to create a unique prefix for names to prevent
another rank or thread inadvertently overwriting data. This prefix should be used
for when creating the name of a tensor, dataset, and model that needs to be unique
to a given rank. (Note: for models run within SmartSim, Additional prefixing may
done by the client when running an ensemble and/or multiple data sources).
Any identifier can be used, though typically the MPI rank number (or equivalent
identifier) is a useful, unique number.</p>
<p>C++:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span> <span class="n">name_prefix</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="nb">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:06}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">rank_id</span><span class="p">);</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rank_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_&quot;</span>
</pre></div>
</div>
<p>Fortran:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="p">::</span> <span class="n">name_prefix</span>
<span class="n">write</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">,</span><span class="s1">&#39;(A,I6.6)&#39;</span><span class="p">)</span> <span class="n">rank_id</span>
</pre></div>
</div>
<p>C:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">name_prefix</span><span class="p">;</span>
<span class="n">name_prefix</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">name_prefix</span><span class="s2">&quot;, &quot;</span><span class="o">%</span><span class="mi">06</span><span class="n">d</span>\<span class="mi">0</span><span class="s2">&quot;, *rank_id);</span>
</pre></div>
</div>
</section>
<section id="storing-scripts-and-models">
<h3>Storing scripts and models<a class="headerlink" href="#storing-scripts-and-models" title="Permalink to this heading">#</a></h3>
<p>The last task that typically needs to be done is to store models or scripts
that will be used later in the simulation. When using a clustered orchestrator,
this only needs to be done by one client (unless each rank requires a different
model or script). MPI rank 0 is often a convenient choice to set models and
scripts.</p>
<p>C++:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">root_client</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_model_from_file</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">root_client</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_model_from_file</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
<p>Fortran:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">root_client</span><span class="p">)</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">client</span><span class="o">%</span><span class="n">set_model_from_file</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">.</span><span class="n">ne</span><span class="o">.</span> <span class="n">SRNoError</span><span class="p">)</span> <span class="n">stop</span> <span class="s1">&#39;Error setting model&#39;</span>
</pre></div>
</div>
<p>C:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">root_client</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">return_code</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">set_model_from_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">!=</span> <span class="n">SRNoError</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="main-loop">
<h2>Main loop<a class="headerlink" href="#main-loop" title="Permalink to this heading">#</a></h2>
<p>Within the main loop of the code (e.g. every timestep or iteration of a solver),
the developer typically uses the SmartRedis client methods to implement a workflow which
may include receiving data, sending data, running a script or model, and/or
retrieving a result. These workflows are covered extensively in the walkthroughs
for the Fortran, C++, and python clients and the integrations with MOM6, OpenFOAM,
LAMMPS, and others.</p>
<p>Generally though, developers are advised to:</p>
<ol class="arabic simple">
<li><p>Find locations where file I/O would normally happen and either augment
or replace code to use the SmartRedis client and store the data in the
orchestrator</p></li>
<li><p>Use the <cite>name_prefix</cite> created during initialization to avoid accidental
writes/reads from different clients</p></li>
<li><p>Use the SmartSim <cite>dataset</cite> type when using clients representing decomposed
subdomains to make the retrieval/use of the data more performant</p></li>
</ol>
</section>
<section id="full-example">
<h2>Full example<a class="headerlink" href="#full-example" title="Permalink to this heading">#</a></h2>
<p>The following pseudocode is used to demonstrate various aspects of instrumenting an
existing simulation code with SmartRedis. This code is representative of solving
the time-evolving heat equation. but we will augment it using an ML model to
provide a preconditioning step each iteration and post the state of the simulation
to the orchestrator.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>program main

    ! Initialize the model, setup MPI, communications, read input files
    call initialize_model(temperature, number_of_timesteps)

    main_loop: do i=1,number_of_timesteps

        ! Write the current state of the simulation to a file
        call write_current_state(temperature)

        ! Call a time integrator to step the temperature field forward
        call timestep_simulation(temperature)

    enddo
end program main
</pre></div>
</div>
<p>Following the guidelines from above, the first step is to initialize the client
and create a unique identifier for the given processor. This should be done
within roughly the same portion of the code where the rest of the model
performs the initialization of other components.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! Import SmartRedis modules
use, only smartredis_client : client_type
! Include all fortran enumerators especially for error checking
include &quot;enum_fortran.inc&quot;

! Declare a new variable called client and a string to create a unique
! name for names
type(client_type) :: smartredis_client
character(len=7)  :: name_prefix
integer :: mpi_rank, mpi_code, return_code

! Note adding use_cluster as an additional runtime argument for SmartRedis
call initialize_model(temperature, number_of_timesteps, use_cluster)
return_code = smartredis_client%initialize(use_cluster)
if (return_code .ne. SRNoError) stop &#39;Error in init&#39;
call MPI_Comm_rank(MPI_COMM_WORLD, mpi_rank, mpi_code)
! Build the prefix for all tensors set in this model
write(name_prefix,&#39;(I6.6,A)&#39;) mpi_rank, &#39;_&#39;

! Assume all ranks will use the same machine learning model, so no need to
! add the prefix to the model name
if (mpi_rank==0) then
    return_code = set_model_from_file(&quot;example_model_name&quot;, &quot;path/to/model.pt&quot;, &quot;TORCH&quot;, &quot;gpu&quot;)
    if (return_code .ne. SRNoError) stop &#39;Error in setting model&#39;
endif
</pre></div>
</div>
<p>Next, add the calls in the main loop to send the temperature to the orchestrator</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>character(len=30), dimension(1) :: model_input, model_output

main_loop: do i=1,number_of_timesteps

    ! Write the current state of the simulation to a file
    call write_current_state(temperature)
    model_input(1) = name_prefix//&quot;temperature&quot;
    model_output(1) = name_prefix//&quot;temperature_out&quot;
    return_code = smartredis_client%put_tensor(model_input(1), temperature)
    if (return_code .ne. SRNoError) stop &#39;Error in putting tensor&#39;

    ! Run the machine learning model
    return_code = smartredis_client%run_model(&quot;example_model_name&quot;, model_input, model_output)
    ! The following line overwrites the prognostic temperature array
    return_code = smartredis_client%unpack_tensor(model_output(1), temperature)
    if (return_code .ne. SRNoError) stop &#39;Error in retrieving tensor&#39;

    ! Call a time integrator to step the temperature field forward
    call timestep_simulation(temperature)

enddo
</pre></div>
</div>
<p>This model will now use the client every timestep to put a
temperature array in the orchestrator, instruct the orchestrator to call
a machine learning model for prediction/inference, and unpack the resulting
inference into the existing temperature array. For more complex examples,
please see some of the integrations in the SmartSim Zoo or feel free to
contact the team at <a class="reference external" href="mailto:CrayLabs&#37;&#52;&#48;hpe&#46;com">CrayLabs<span>&#64;</span>hpe<span>&#46;</span>com</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="smartredis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">SmartRedis</p>
      </div>
    </a>
    <a class="right-next"
       href="sr_python_walkthrough.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Python</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization">Initialization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-client">Creating the client</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-programs-creating-unique-names">(Parallel Programs): Creating unique names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-scripts-and-models">Storing scripts and models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-loop">Main loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-example">Full example</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cray Labs
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2023, Hewlett Packard Enterprise.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  Questions? You can contact <a href="mailto:craylabs@hpe.com">contact us</a> or <a href="https://join.slack.com/t/craylabs/shared_invite/zt-nw3ag5z5-5PS4tIXBfufu1bIvvr71UA">join us on Slack!</a>
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>